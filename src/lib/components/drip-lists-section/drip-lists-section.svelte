<script lang="ts">
  import assert from '$lib/utils/assert';
  import DripListIcon from '$lib/components/icons/DripList.svelte';
  import DripListCardThumblink, {
    DRIP_LIST_CARD_THUMBLINK_FRAGMENT,
  } from '../drip-list-card/drip-list-card-thumblink.svelte';
  import Plus from '$lib/components/icons/Plus.svelte';
  import walletStore from '$lib/stores/wallet/wallet.store';
  import Section from '../section/section.svelte';
  import { AddressDriverClient } from 'radicle-drips';
  import Button from '../button/button.svelte';
  import Illustration from '../icons/‚úèÔ∏è.svelte';
  import { gql } from 'graphql-request';
  import type { DripListsQuery, DripListsQueryVariables } from './__generated__/gql.generated';
  import query from '$lib/graphql/dripsQL';
  import modal from '$lib/stores/modal';
  import CreateDripListStepper from '$lib/flows/create-drip-list-flow/create-drip-list-stepper.svelte';
  import * as multiplayer from '$lib/utils/multiplayer';
  import type { VotingRound } from '$lib/utils/multiplayer/schemas';
  import { mapSplitsFromMultiplayerResults } from '../splits/splits.svelte';

  export let accountId: string | undefined;
  export let collapsed = false;
  export let collapsable = false;
  export let showCreateNewListCard = false;

  let error = false;

  let dripLists: DripListsQuery['dripLists'] | undefined;
  let votingRounds: VotingRound[] | undefined;
  async function updateDripLists() {
    try {
      assert(accountId);
      const address = AddressDriverClient.getUserAddress(accountId);

      const dripListsQuery = gql`
        ${DRIP_LIST_CARD_THUMBLINK_FRAGMENT}
        query DripLists($where: DripListWhereInput) {
          dripLists(where: $where) {
            ...DripListCardThumblink
          }
        }
      `;

      const fetches = await Promise.all([
        query<DripListsQuery, DripListsQueryVariables>(dripListsQuery, {
          where: {
            ownerAddress: address,
          },
        }),
        multiplayer.getVotingRounds({ publisherAddress: address }),
      ] as const);

      dripLists = fetches[0].dripLists;
      votingRounds = fetches[1].filter((v) => {
        // filter out votingRounds that already are associated with a drip list based on votingRound.dripListId
        return !dripLists?.some((dl) => dl.account.accountId === v.dripListId);
      });

      // add voting results as splits table data
      const votingRoundsWithResults = votingRounds.filter((v) => v.result);
      const splits = await Promise.all(
        votingRoundsWithResults.map((v) => v.result && mapSplitsFromMultiplayerResults(v.result)),
      );
      votingRounds = votingRounds.map((v) => ({
        ...v,
        splits: splits[votingRoundsWithResults.findIndex((vR) => vR.id === v.id)],
      }));
    } catch (e) {
      // eslint-disable-next-line no-console
      console.error(e);
      error = true;
    }
  }
  $: accountId && updateDripLists();

  $: dripListsAndVotingRounds = [
    ...(dripLists?.map((dl) => ({ ...dl, type: 'drip-list' as const })) ?? []),
    ...(votingRounds?.map((dl) => ({ ...dl, type: 'voting-round' as const })) ?? []),
  ];

  $: isSelf = Boolean(accountId && accountId === $walletStore.dripsAccountId);
</script>

<Section
  bind:collapsed
  bind:collapsable
  header={{
    icon: DripListIcon,
    label: 'Drip Lists',
    actionsDisabled: !dripLists,
    actions: isSelf
      ? [
          {
            label: 'Create Drip List',
            icon: Plus,
            handler: () =>
              modal.show(CreateDripListStepper, undefined, {
                skipWalletConnect: true,
                isModal: true,
              }),
          },
        ]
      : [],
  }}
  skeleton={{
    loaded: error || dripLists !== undefined,
    empty: dripListsAndVotingRounds.length === 0 ?? undefined,
    error,
    emptyStateEmoji: 'ü´ó',
    emptyStateHeadline: isSelf ? 'You don ºt have any Drip Lists' : 'No Drip Lists',
    emptyStateText: isSelf
      ? 'Create a Drip List to start supporting your dependencies'
      : 'Drip Lists enable supporting a set of open-source projects',
    horizontalScroll: false,
  }}
>
  {#if dripListsAndVotingRounds}
    <div
      class="grid gap-6 grid-cols-1 padding pt-px {dripListsAndVotingRounds.length > 0
        ? 'lg:grid-cols-2'
        : ''}"
    >
      {#each dripListsAndVotingRounds as list}
        {#if list.type === 'drip-list'}
          <DripListCardThumblink dripList={list} />
        {:else}
          <DripListCardThumblink votingRound={list} />
        {/if}
      {/each}
      {#if showCreateNewListCard}
        <div
          class="shadow-low rounded-drip-lg flex items-center justify-center p-1"
          style:min-height="398px"
        >
          <div class="flex flex-col items-center gap-2 text-center">
            <Illustration size={48} />
            <h6 class="typo-text-bold">Got a new idea?</h6>
            <p>You can create as many Drip Lists as you like.</p>
            <div class="mt-2">
              <Button
                icon={Plus}
                on:click={() =>
                  modal.show(CreateDripListStepper, undefined, {
                    skipWalletConnect: true,
                    isModal: true,
                  })}>Create a new Drip List</Button
              >
            </div>
          </div>
        </div>
      {/if}
    </div>
  {/if}
</Section>
